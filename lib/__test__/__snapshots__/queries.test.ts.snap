// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`createClusterQuery should create a clustered Query 1`] = `
"
with filtered AS
       
    (SELECT $1.$2, 1 as theCount $3
    FROM public.stations
    WHERE ST_Intersects(TileBBox($4, $5, $6, 3857), ST_Transform($7.$8, 3857))
        $9
    ),
    clustered_$10 AS
    (SELECT $11 as center,
        theCount,
        ST_ClusterDBSCAN($12, $13, 1) over () as clusters $14
    FROM filtered),
    grouped_clusters_$15 AS
    (SELECT SUM(theCount) as theCount,
        $16
        ST_Centroid(ST_Collect(center)) as center
    FROM clustered_$17
    GROUP BY clusters),

    
    clustered_9 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 0.01953125, 1) over () as clusters , a
        FROM grouped_clusters_10),
    grouped_clusters_9 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_9
        GROUP BY clusters),

    clustered_8 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 0.0390625, 1) over () as clusters , a
        FROM grouped_clusters_9),
    grouped_clusters_8 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_8
        GROUP BY clusters),

    clustered_7 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 0.078125, 1) over () as clusters , a
        FROM grouped_clusters_8),
    grouped_clusters_7 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_7
        GROUP BY clusters),

    clustered_6 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 0.15625, 1) over () as clusters , a
        FROM grouped_clusters_7),
    grouped_clusters_6 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_6
        GROUP BY clusters),

    clustered_5 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 0.3125, 1) over () as clusters , a
        FROM grouped_clusters_6),
    grouped_clusters_5 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_5
        GROUP BY clusters),

    clustered_4 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 0.625, 1) over () as clusters , a
        FROM grouped_clusters_5),
    grouped_clusters_4 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_4
        GROUP BY clusters),

    clustered_3 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 1.25, 1) over () as clusters , a
        FROM grouped_clusters_4),
    grouped_clusters_3 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_3
        GROUP BY clusters),

    clustered_2 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 2.5, 1) over () as clusters , a
        FROM grouped_clusters_3),
    grouped_clusters_2 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_2
        GROUP BY clusters),

    clustered_1 AS
        (SELECT center,
            theCount,
            ST_ClusterDBSCAN(center, 5, 1) over () as clusters , a
        FROM grouped_clusters_2),
    grouped_clusters_1 AS
        (SELECT SUM(theCount) as theCount,
            FIRST(a) as a,
            ST_Centroid(ST_Collect(center)) as center
        FROM clustered_1
        GROUP BY clusters),

     tiled as
    (SELECT center,
            theCount $18
     FROM grouped_clusters_$19
     WHERE ST_Intersects(TileBBox($20, $21, $22, 3857), ST_Transform(center, 3857))),
     q as
    (SELECT 1 as c1,
            ST_AsMVTGeom(ST_Transform(center, 3857), TileBBox($23, $24, $25, 3857), $26, 10, false) AS geom,
            jsonb_build_object('count', theCount$27) as attributes
     FROM tiled)
SELECT ST_AsMVT(q, '$28', $29, 'geom') as mvt
from q
"
`;

exports[`createClusterQuery should create a clustered Query 2`] = `
Array [
  "public.stations",
  "wkb_geometry",
  ", a",
  1,
  0,
  1,
  "public.stations",
  "wkb_geometry",
  "AND status = status AND [1, 2] @> [2, 3]",
  10,
  "wkb_geometry",
  "wkb_geometry",
  0.009765625,
  ", a",
  10,
  "FIRST(a) as a,",
  10,
  ", a",
  1,
  1,
  0,
  1,
  1,
  0,
  1,
  512,
  ", 'a', a",
  "points",
  512,
]
`;

exports[`createClusterQuery should create a unclustered Query 1`] = `
Object {
  "sql": "
WITH filtered AS
    (SELECT $1.$2 $3
    FROM public.stations
    WHERE ST_Intersects(TileBBox($4, $5, $6, 3857), ST_Transform($7.$8, 3857))
      $9
    ),
    q as
    (SELECT 1 as c1,
            ST_AsMVTGeom(ST_Transform($10, 3857), TileBBox($11, $12, $13, 3857), $14, 10, false) AS geom,
            jsonb_build_object('count', 1$15) as attributes
     FROM filtered)
SELECT ST_AsMVT(q, '$16', $17, 'geom') as mvt
from q
",
  "type": "SLONIK_TOKEN_SQL",
  "values": Array [
    "public.stations",
    "wkb_geometry",
    ", a",
    15,
    0,
    1,
    "public.stations",
    "wkb_geometry",
    "",
    "wkb_geometry",
    15,
    0,
    1,
    512,
    ", 'a', a",
    "points",
    512,
  ],
}
`;
